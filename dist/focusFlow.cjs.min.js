// * Released under the MIT License.

"use strict";function t(t,e){for(var n=0;e.length>n;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function e(t,e){return t(e={exports:{}},e.exports),e.exports}function n(t,e,n,r,i,o,s){try{var u=t[o](s),c=u.value}catch(t){return void n(t)}u.done?e(c):Promise.resolve(c).then(r,i)}function r(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,r)}return n}function i(t){for(var e=arguments,n=1;arguments.length>n;n++){var i=null!=e[n]?e[n]:{};n%2?r(Object(i),!0).forEach(function(e){o(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):r(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}var o=function(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t},s=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},u=function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e},c=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};s(this,t),o(this,"pond",[]),o(this,"threads",[]),o(this,"queue",[]),o(this,"queueExit",!0),o(this,"event",{full:null}),this.defaults(e),this.junction()}return u(t,[{key:"defaults",value:function(t){this.options=Object.assign({threadMax:1,switch:!0,life:-1,hand:null,queue:!1,queueMax:10},t)}},{key:"junction",value:function(){function t(t,e){e()}this.basic={},this.error(function(t,e,n){console.error(t),n()}).success(t).fail(t).end(function(){})}},{key:"length",get:function(){return this.pond.length}},{key:"ram",get:function(){return this.options.switch&&this.options.threadMax>this.threads.length}},{key:"queueFull",get:function(){return this.options.queue&&this.options.queueMax>this.queue.length}}]),t}();o(c,"_id",0);var a=e(function(t){function e(n){return t.exports=e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},e(n)}t.exports=e}),h=e(function(t){var e=function(t){function e(t,e,n,i){var o=e&&e.prototype instanceof r?e:r,s=Object.create(o.prototype),u=new l(i||[]);return s._invoke=c(t,n,u),s}function n(t,e,n){try{return{type:"normal",arg:t.call(e,n)}}catch(t){return{type:"throw",arg:t}}}function r(){}function i(){}function o(){}function s(t){["next","throw","return"].forEach(function(e){t[e]=function(t){return this._invoke(e,t)}})}function u(t,e){function r(i,o,s,u){var c=n(t[i],t,o);if("throw"!==c.type){var a=c.arg,h=a.value;return h&&"object"==typeof h&&g.call(h,"__await")?e.resolve(h.__await).then(function(t){r("next",t,s,u)},function(t){r("throw",t,s,u)}):e.resolve(h).then(function(t){a.value=t,s(a)},function(t){return r("throw",t,s,u)})}u(c.arg)}var i;this._invoke=function(t,n){function o(){return new e(function(e,i){r(t,n,e,i)})}return i=i?i.then(o,o):o()}}function c(t,e,r){var i=k;return function(o,s){if(i===E)throw Error("Generator is already running");if(i===j){if("throw"===o)throw s;return d()}for(r.method=o,r.arg=s;;){var u=r.delegate;if(u){var c=a(u,r);if(c){if(c===L)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(i===k)throw i=j,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);i=E;var h=n(t,e,r);if("normal"===h.type){if(i=r.done?j:O,h.arg===L)continue;return{value:h.arg,done:r.done}}"throw"===h.type&&(i=j,r.method="throw",r.arg=h.arg)}}}function a(t,e){var r=t.iterator[e.method];if(r===v){if(e.delegate=null,"throw"===e.method){if(t.iterator.return&&(e.method="return",e.arg=v,a(t,e),"throw"===e.method))return L;e.method="throw",e.arg=new TypeError("The iterator does not provide a 'throw' method")}return L}var i=n(r,t.iterator,e.arg);if("throw"===i.type)return e.method="throw",e.arg=i.arg,e.delegate=null,L;var o=i.arg;return o?o.done?(e[t.resultName]=o.value,e.next=t.nextLoc,"return"!==e.method&&(e.method="next",e.arg=v),e.delegate=null,L):o:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,L)}function h(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function f(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function l(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(h,this),this.reset(!0)}function p(t){if(t){var e=t[b];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var n=-1,r=function e(){for(;++n<t.length;)if(g.call(t,n))return e.value=t[n],e.done=!1,e;return e.value=v,e.done=!0,e};return r.next=r}}return{next:d}}function d(){return{value:v,done:!0}}var v,y=Object.prototype,g=y.hasOwnProperty,x="function"==typeof Symbol?Symbol:{},b=x.iterator||"@@iterator",m=x.asyncIterator||"@@asyncIterator",w=x.toStringTag||"@@toStringTag";t.wrap=e;var k="suspendedStart",O="suspendedYield",E="executing",j="completed",L={},q={};q[b]=function(){return this};var $=Object.getPrototypeOf,P=$&&$($(p([])));P&&P!==y&&g.call(P,b)&&(q=P);var S=o.prototype=r.prototype=Object.create(q);return i.prototype=S.constructor=o,o.constructor=i,o[w]=i.displayName="GeneratorFunction",t.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===i||"GeneratorFunction"===(e.displayName||e.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,o):(t.__proto__=o,w in t||(t[w]="GeneratorFunction")),t.prototype=Object.create(S),t},t.awrap=function(t){return{__await:t}},s(u.prototype),u.prototype[m]=function(){return this},t.AsyncIterator=u,t.async=function(n,r,i,o,s){s===v&&(s=Promise);var c=new u(e(n,r,i,o),s);return t.isGeneratorFunction(r)?c:c.next().then(function(t){return t.done?t.value:c.next()})},s(S),S[w]="Generator",S[b]=function(){return this},S.toString=function(){return"[object Generator]"},t.keys=function(t){var e=[];for(var n in t)e.push(n);return e.reverse(),function n(){for(;e.length;){var r=e.pop();if(r in t)return n.value=r,n.done=!1,n}return n.done=!0,n}},t.values=p,l.prototype={constructor:l,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=v,this.done=!1,this.delegate=null,this.method="next",this.arg=v,this.tryEntries.forEach(f),!t)for(var e in this)"t"===e.charAt(0)&&g.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=v)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){function e(e,r){return o.type="throw",o.arg=t,n.next=e,r&&(n.method="next",n.arg=v),!!r}if(this.done)throw t;for(var n=this,r=this.tryEntries.length-1;r>=0;--r){var i=this.tryEntries[r],o=i.completion;if("root"===i.tryLoc)return e("end");if(this.prev>=i.tryLoc){var s=g.call(i,"catchLoc"),u=g.call(i,"finallyLoc");if(s&&u){if(i.catchLoc>this.prev)return e(i.catchLoc,!0);if(i.finallyLoc>this.prev)return e(i.finallyLoc)}else if(s){if(i.catchLoc>this.prev)return e(i.catchLoc,!0)}else{if(!u)throw Error("try statement without catch or finally");if(i.finallyLoc>this.prev)return e(i.finallyLoc)}}}},abrupt:function(t,e){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(this.prev>=r.tryLoc&&g.call(r,"finallyLoc")&&r.finallyLoc>this.prev){var i=r;break}}!i||"break"!==t&&"continue"!==t||i.tryLoc>e||e>i.finallyLoc||(i=null);var o=i?i.completion:{};return o.type=t,o.arg=e,i?(this.method="next",this.next=i.finallyLoc,L):this.complete(o)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),L},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),f(n),L}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.tryLoc===t){var r=n.completion;if("throw"===r.type){var i=r.arg;f(n)}return i}}throw Error("illegal catch attempt")},delegateYield:function(t,e,n){return this.delegate={iterator:p(t),resultName:e,nextLoc:n},"next"===this.method&&(this.arg=v),L}},t}(t.exports);try{regeneratorRuntime=e}catch(t){Function("t","regeneratorRuntime=t")(e)}}),f=function(t){return function(){var e=this,r=arguments;return new Promise(function(i,o){function s(t){n(c,i,o,s,u,"next",t)}function u(t){n(c,i,o,s,u,"throw",t)}var c=t.apply(e,r);s(void 0)})}},l={use:function(t,e,n){if("function"==typeof t)e&&(n=e),e=t,t=this.pond.length;else if("number"==typeof t)t=this.pond.length;else if(t instanceof c)return this.docking(t,e);return e=this.redirect(e,n),this.pond.push({sign:t,callback:e}),this},error:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.options.hand,n=this.basic;return t=this.redirect(t,e),n.error=function(){var e=f(h.mark(function e(n,r){return h.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r.ctx.$info.index=null,e.next=3,t(n,r.ctx,r.$next,r.$close);case 3:case"end":return e.stop()}},e)}));return function(t,n){return e.apply(this,arguments)}}(),this},success:function(t,e){return this.isState("success",t,e)},fail:function(t,e){return this.isState("fail",t,e)},end:function(t){var e=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.options.hand,r=this.basic;return t=this.redirect(t,n),r.end=function(){var n=f(h.mark(function n(r){return h.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return e.closeThread(r),n.next=3,t(r.ctx);case 3:case"end":return n.stop()}},n)}));return function(t){return n.apply(this,arguments)}}(),this},isState:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.options.hand;return e=this.redirect(e,n),this.basic[t]=function(){var t=f(h.mark(function t(n){return h.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n.ctx.$info.index=null,t.next=3,e(n.ctx,n.$next,n.$close);case 3:case"end":return t.stop()}},t)}));return function(e){return t.apply(this,arguments)}}(),this},docking:function(t){var e=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.options.hand;return t.pond.forEach(function(t){return e.use(t.sign,t.callback,n)}),this},redirect:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.options.hand;return"object"===a(e)&&null!==e?t.bind(e):t}},p=function(){function t(e,n){s(this,t),o(this,"$next",this.next.bind(this)),o(this,"$close",this.close.bind(this)),o(this,"onceZero",!0),this.ctx=Object.assign({},n),this.ff=e,this.initInfo(e)}return u(t,[{key:"initInfo",value:function(t){var e={id:c._id++,ff:t,index:0};Object.defineProperty(this.ctx,"$info",{value:e}),this.active()}},{key:"next",value:function(t,e){if(t instanceof c)return this.span(t,e);var n=this.ctx.$info.ff;this.active(),"boolean"==typeof t?n.run(this,t):void 0!==t&&"boolean"!=typeof t?n.nextStart(this,t):n.run(this)}},{key:"span",value:function(t,e){return this.close(),t.start(this.ctx,e),this}},{key:"active",value:function(){var t=this.ctx.$info;-1!==t.ff.options.life&&(t.life=Date.now()+t.ff.options.life)}},{key:"close",value:function(){this.ff.closeThread(this)}}]),t}(),d={inspect:function(){return!this.ram&&!this.clean()},close:function(){return this.options.switch=!1,this},open:function(){return this.options.switch=!0,this.processNextMessage(),this},newThread:function(t){var e=new p(this,t);return this.threads.push(e),e},closeThread:function(t){var e=this.threads.findIndex(function(e){return e===t});this.threads.splice(e,1+e),this.processNextMessage()},emptyThreads:function(){return this.threads=[],this.processNextMessage(),this},clean:function(){var t=this.threads.length;return(this.threads=this.threads.filter(function(t){return-1===t.ctx.$info.life||t.ctx.$info.life>Date.now()})).length>t}},v={start:function(t,e){if("object"!==a(t)){var n=[e,t];t=n[0],e=n[1]}return this.spill(t,e)?this:(this.newThread(t).next(e),this)},nextStart:function(t,e){var n=this.matching(e);t.ctx.$info.index=-1===n?t.onceZero?0:t.ctx.$info.index++:n,t.onceZero&&(t.onceZero=!1),this.run(t)},run:function(t,e){return function(){return f(h.mark(function t(e,n){var r,i,o;return h.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(r=this.pond,i=e.ctx,o=r.length>i.$info.index,t.prev=3,null!==i.$info.index){t.next=9;break}return t.next=7,this.basic.end(e);case 7:t.next=20;break;case 9:if(!1!==n){t.next=14;break}return t.next=12,this.basic.fail(e);case 12:t.next=20;break;case 14:if(o&&!0!==n){t.next=19;break}return t.next=17,this.basic.success(e);case 17:t.next=20;break;case 19:o&&r[i.$info.index++].callback(i,e.$next,e.$close);case 20:t.next=25;break;case 22:t.prev=22,t.t0=t.catch(3),this.basic.error(t.t0,e);case 25:case"end":return t.stop()}},t,this,[[3,22]])})).apply(this,arguments)}.apply(this,arguments)},spill:function(t,e){return!!this.inspect()&&("function"==typeof this.event.full&&this.event.full(t,this),this.queueFull?this.queue.push({ctx:t,sign:e}):this.options.queue&&"function"==typeof this.event.queueFull&&this.event.queueFull(t,this),!0)},matching:function(t){var e=this.pond;return"number"!=typeof t?e.findIndex(function(e){return e.sign===t}):e.length>t?t:-1}},y={onFull:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.options.hand;return t=this.redirect(t,e),this.event.full=t,this},onQueueFull:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.options.hand;return t=this.redirect(t,e),this.event.queueFull=t,this}},g={processNextMessage:function(){this.queue.length&&this.queueExit&&(this.start(this.queue.shift()),this.ram&&this.processNextMessage())},closeQueue:function(){return this.options.queue=!1,this},openQueue:function(){return this.options.queue=!0,this},emptyQueue:function(){return this.queue=[],this},closeExit:function(){return this.queueExit=!1,this},openExit:function(){return this.queueExit=!0,this.processNextMessage(),this}},x=c.prototype,b=i(i(i(i(i({},l),d),v),y),g);Object.keys(b).forEach(function(t){Object.defineProperty(x,t,{value:b[t]})}),module.exports=c;